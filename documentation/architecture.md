# Architecture Overview

## System map
- **Backend.** A FastAPI application under `app/` serves the public API, orchestrated by `create_app` in `app/main.py`. The CLI entry point (`python -m app.cli`) wraps uvicorn so operators can launch the server, import legacy data, or trigger Android build helpers from a single tool.【F:app/main.py†L1-L49】【F:app/cli.py†L1-L80】 Persistent storage uses SQLAlchemy models backed by SQLite; configuration derives from environment-driven settings in `app/config.py`, and the database engine/session wiring lives in `app/db/session.py` with automatic table creation in `app/db/migrate.py`.【F:app/config.py†L1-L36】【F:app/db/session.py†L1-L60】【F:app/db/migrate.py†L1-L28】
- **API surface.** Modular routers handle agents, rituals, quick posts, on-demand generation, and vault export flows. They compose shared dependencies for database sessions and API-key enforcement so write operations can be gated outside development environments.【F:app/api/agents.py†L1-L47】【F:app/api/rituals.py†L1-L52】【F:app/api/posts.py†L1-L52】【F:app/api/generate.py†L1-L44】【F:app/api/vault.py†L1-L40】【F:app/api/dependencies.py†L1-L32】
- **Background work.** A lightweight APScheduler instance (`app/engine/scheduler.py`) runs inside the FastAPI lifespan hook to periodically call the threadlight content generator (`app/engine/generator.py`) and persist fresh vault entries, mirroring how automated rituals populate the system.【F:app/main.py†L15-L33】【F:app/engine/scheduler.py†L1-L38】【F:app/engine/generator.py†L1-L18】
- **Frontend.** The dashboard now lives under `web-app/` as a Vite + React 18 single-page app. React Router renders the navigation shell while React Query fetches resources through a small Axios client that respects the configurable `VITE_API_BASE` proxy. The dev server proxies `/api` traffic to the FastAPI backend during local runs.【F:web-app/src/App.tsx†L1-L31】【F:web-app/src/pages/Dashboard.tsx†L1-L46】【F:web-app/src/pages/Vault.tsx†L1-L44】【F:web-app/src/lib/api.ts†L1-L5】【F:web-app/vite.config.ts†L1-L15】
- **Packaging & tooling.** Root npm scripts wrap the Python backend (`npm run dev:backend`) and Vite frontend (`npm run dev:frontend`). Android helpers live under `scripts/` and can be invoked via the CLI `build-apk-helper` command for repeatable APK builds.【F:package.json†L1-L18】【F:app/cli.py†L52-L80】【F:scripts/build_apk_debug.sh†L1-L40】

## Runtime flow
1. `python -m app.cli runserver` boots uvicorn using the settings in `app/config.py`. The FastAPI lifespan hook runs migrations, migrates any legacy vault JSON into SQLite, and starts the background scheduler when enabled.【F:app/cli.py†L10-L33】【F:app/config.py†L1-L36】【F:app/main.py†L15-L44】【F:app/db/legacy.py†L1-L67】
2. Incoming requests acquire a SQLAlchemy session via `get_db`, then call into models for CRUD. API-key requirements are enforced on mutating routes when `AGENT_SPARK_DEV_MODE` is false and `AGENT_SPARK_API_KEY` is set.【F:app/api/dependencies.py†L1-L32】【F:app/config.py†L8-L28】【F:app/api/agents.py†L29-L43】【F:app/api/posts.py†L30-L52】
3. Generated content (manual or scheduled) persists as `VaultRecord` rows. Vault export streams JSON payloads so operators can archive or migrate data without touching the database directly.【F:app/api/generate.py†L19-L44】【F:app/api/vault.py†L13-L40】【F:app/models/vault.py†L1-L44】
4. The React dashboard issues REST calls through the shared Axios client. Dashboards hydrate lists of agents, rituals, posts, and vault entries, and provide direct export actions that hit the API endpoints above.【F:web-app/src/lib/api.ts†L1-L5】【F:web-app/src/pages/Dashboard.tsx†L13-L45】【F:web-app/src/pages/Logs.tsx†L1-L48】【F:web-app/src/pages/Vault.tsx†L11-L43】
5. Background scheduler executions append new vault records every 15 minutes (configurable by disabling the scheduler). Log output appears in standard logging streams so operators can audit background work during deploys.【F:app/engine/scheduler.py†L14-L38】

## State & data
- **Database layout.** Models for agents, rituals, posts, and vault entries inherit from the shared SQLAlchemy base and persist JSON-friendly payloads so the React client can hydrate structured objects.【F:app/models/agent.py†L1-L40】【F:app/models/ritual.py†L1-L44】【F:app/models/post.py†L1-L40】【F:app/models/vault.py†L1-L44】
- **Legacy migration.** On first run the system ingests `data/vault.json` (if present), storing records in SQLite and renaming the source file with a timestamp suffix. Corrupt payloads are quarantined automatically.【F:app/db/legacy.py†L27-L67】
- **Secrets & auth.** `AGENT_SPARK_API_KEY` enables API-key enforcement, while `AGENT_SPARK_DEV_MODE` toggles relaxed behaviour for local development. Additional paths like `AGENT_SPARK_DB_PATH`, `AGENT_SPARK_DATA_DIR`, and `AGENT_SPARK_SCHEDULER_ENABLED` let operators relocate data files or disable background jobs.【F:app/config.py†L8-L28】【F:app/api/dependencies.py†L18-L31】

## Testing layers
- **Backend.** Pytest suites cover API endpoints, legacy migration, and concurrent quickpost behaviour to ensure data integrity and race-safety in the SQLite layer.【F:tests/backend/test_api.py†L1-L120】【F:tests/backend/test_migration.py†L1-L80】【F:tests/concurrency/test_quickpost_concurrency.py†L1-L90】
- **Frontend.** Vite and React live reload serve day-to-day development, while linting and TypeScript checks run through the `web/` package scripts before shipping new bundles.【F:web-app/package.json†L1-L22】

## Extensibility
- Add new API routes by defining routers in `app/api/` and wiring ORM models; shared dependencies expose sessions and security primitives to keep handlers concise.【F:app/api/dependencies.py†L1-L32】
- Extend scheduled automation by registering additional APScheduler jobs in `app/engine/scheduler.py` or toggling scheduler behaviour through `AGENT_SPARK_SCHEDULER_ENABLED`.【F:app/engine/scheduler.py†L14-L38】【F:app/config.py†L17-L28】
- Modify the React dashboard inside `web-app/src/`—Axios client configuration and proxy rules already centralize backend access so deployments can point at remote FastAPI instances via `VITE_API_BASE`.【F:web-app/src/lib/api.ts†L1-L5】【F:web-app/vite.config.ts†L1-L15】
