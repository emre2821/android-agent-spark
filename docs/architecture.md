# Architecture Overview

## System map
- **Client.** React 18 + Vite drives the dashboard experience. Routing is handled with `react-router-dom`, React Query powers data fetching/caching, and shared state is exposed through providers in `src/hooks` (`AuthProvider`, `AgentsProvider`, and `WorkflowsProvider`). UI primitives live under `src/components/ui` and mirror the shadcn/ui design system.【F:src/App.tsx†L1-L52】【F:src/hooks/use-auth.tsx†L1-L190】
- **Server.** `server/workspaceServer.js` hosts the JWT-protected workspace API, while `server/index.js` runs the agent runtime with REST endpoints, workflow revision APIs, and the WebSocket gateway. Supporting modules handle persistence (`server/storage.js`), workspace seed data (`server/data.js`), and workflow versioning (`server/workflowStore.js`).【F:server/workspaceServer.js†L1-L240】【F:server/index.js†L1-L484】【F:server/storage.js†L1-L140】【F:server/data.js†L1-L120】【F:server/workflowStore.js†L1-L120】
- **Build & tooling.** Vite orchestrates local development and production builds, TailwindCSS supplies styling utilities, and Vitest + Testing Library cover unit/integration suites. Cypress handles end-to-end validation, while Capacitor/Electron scripts package the SPA for mobile and desktop runtimes.【F:package.json†L1-L80】【F:vite.config.ts†L1-L60】

## Runtime flow
1. `src/main.tsx` mounts `<App />`, which wraps the router with React Query, authentication, agent, and workflow providers so downstream components receive hydrated context values.【F:src/main.tsx†L1-L18】【F:src/App.tsx†L1-L52】
2. Users are redirected to `/login` until they authenticate. `AuthProvider` exchanges credentials for a JWT via `POST /auth/login`, stores it in `localStorage`, and fetches the user/workspace roster from `/auth/me`. Workspace selection is persisted across reloads so downstream hooks always know which workspace to query.【F:src/hooks/use-auth.tsx†L26-L131】【F:server/workspaceServer.js†L38-L210】
3. Once authenticated, `AgentsProvider` derives the API/WebSocket base URLs from configuration, loads agent summaries from `GET /agents`, subscribes to `/ws` for live updates, and exposes mutation helpers that call the REST API. Optimistic updates keep the React Query cache responsive while the server broadcasts authoritative changes.【F:src/hooks/use-agents.tsx†L1-L220】【F:src/lib/api/config.ts†L1-L46】【F:server/index.js†L120-L360】
4. Workflow-oriented views use `WorkflowsProvider` to manage builder state, version snapshots, and execution logs locally while delegating long-term storage to workflow APIs. Collaboration and notifications modules attach to the WebSocket stream to surface run progress in the UI.【F:src/hooks/use-workflows.tsx†L1-L140】【F:src/components/WorkflowRunNotifications.tsx†L1-L160】【F:server/workflowStore.js†L120-L220】
5. The Express server writes agent/task/memory records to SQLite (configurable via `AGENT_DB_PATH`) and workflow definitions to JSON (`WORKFLOW_STORE_PATH`). Whenever data mutates, broadcast helpers fan events out to all connected WebSocket clients so multiple dashboards stay synchronized.【F:server/storage.js†L1-L210】【F:server/index.js†L320-L424】【F:server/workflowStore.js†L1-L160】

## State & data
- **Authentication & workspace context.** JWTs and selected workspace IDs persist in `localStorage`. The auth hook exposes helpers for login/logout, workspace switching, and guards routes with `<ProtectedRoute />`. Workspace metadata and seeded credentials live in `server/data.js` for quick local bootstrapping.【F:src/hooks/use-auth.tsx†L24-L204】【F:src/components/ProtectedRoute.tsx†L1-L40】【F:server/data.js†L1-L200】
- **Agents.** React Query caches the `/agents` collection and detail fetches. `useAgents` layers optimistic updates and websocket listeners on top of REST mutations so UI state never drifts from server truth.【F:src/hooks/use-agents.tsx†L1-L320】【F:server/index.js†L120-L360】
- **Workflows.** Builder state lives in `WorkflowsProvider`, which tracks steps, execution logs, and version history while delegating persistence/exports to the backend workflow store. Zod-powered node definitions under `src/lib/nodes` ensure runtime configs remain valid.【F:src/hooks/use-workflows.tsx†L1-L200】【F:server/workflowStore.js†L1-L220】【F:src/lib/nodes/index.ts†L1-L160】
- **Offline caching.** `src/lib/offline-storage.ts` exposes IndexedDB/Capacitor-backed helpers that let mobile/desktop bundles hydrate from cached agents and workflows when the API is unreachable.【F:src/lib/offline-storage.ts†L1-L160】

## Real-time & collaboration
- The WebSocket server mounted at `/ws` sends agent/task/memory events and simulated task stream logs. `useAgents` and collaboration clients derive URLs from `VITE_API_URL` and handle reconnection semantics to keep dashboards warm.【F:server/index.js†L200-L380】【F:src/lib/collaboration/collaborationClient.ts†L1-L200】
- Collaboration features coordinate edits through the `CollaborationClient`, which multiplexes presence and selection updates over the same WebSocket channel.【F:src/lib/collaboration/collaborationClient.ts†L1-L220】

## Testing layers
- **Component & hook tests.** Vitest + Testing Library cover UI and provider logic. Mock WebSocket implementations validate streaming behaviour within `src/hooks/__tests__/use-agents.test.tsx`.【F:src/hooks/__tests__/use-agents.test.tsx†L1-L240】
- **Server integration.** Supertest and WebSocket clients exercise the Express API and `/ws` gateway to guarantee the contract stays regression-free (`server/__tests__/server.integration.test.ts`).【F:server/__tests__/server.integration.test.ts†L1-L160】
- **End-to-end.** Cypress specs in `cypress/e2e` run against a production build served via `npm run preview`, mirroring the release bundle paths and websocket proxying configured in `vite.config.ts`.【F:cypress/e2e/agents.cy.ts†L1-L160】【F:vite.config.ts†L1-L60】

## Extensibility
- Swap the bundled Express server for production infrastructure by re-implementing the REST/WebSocket contract exposed under `/agents`, `/auth`, `/workflows`, and `/ws`. The client resolves API roots via `VITE_API_URL`, so deployments can point at remote services without code changes.【F:src/lib/api/config.ts†L1-L46】【F:server/workspaceServer.js†L38-L240】【F:server/index.js†L120-L484】
- Register new automation nodes by extending `src/lib/nodes`. Each definition provides Zod validation, access to credentials, and structured logging hooks so workflow executions stay observable.【F:src/lib/nodes/index.ts†L1-L200】
- Package additional runtimes (Capacitor, Electron) using the existing npm scripts. They compile the same Vite bundle while enabling native bridges through platform-specific entry points.【F:package.json†L1-L80】
