name: Ultimate Workflow

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: ultimate-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CI: true
  PYTHONUNBUFFERED: '1'

jobs:
  node-quality:
    name: Node quality (Node.js ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [18, 20]
    timeout-minutes: 25
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm
          cache-dependency-path: |
            package-lock.json
            frontend-app/package-lock.json
            web-app/package-lock.json
            nodejs-server/package-lock.json

      - name: Install root dependencies
        run: npm ci --ignore-scripts

      - name: Install frontend dependencies
        working-directory: frontend-app
        run: npm ci --ignore-scripts

      - name: Install web dependencies
        working-directory: web-app
        run: npm ci --ignore-scripts

      - name: Install server dependencies
        working-directory: nodejs-server
        run: npm ci --ignore-scripts

      - name: Lint (all projects)
        run: npm run lint

      - name: Type check (frontend)
        working-directory: frontend-app
        run: npm run typecheck

      - name: Type check (web)
        working-directory: web-app
        run: npx tsc --noEmit --project tsconfig.json

      - name: Run tests (web + server)
        run: npm test

      - name: Run tests (frontend)
        working-directory: frontend-app
        run: npm run test

      - name: Build web app
        working-directory: web-app
        run: npm run build

      - name: Build frontend app
        working-directory: frontend-app
        run: npm run build

      - name: Build server
        run: npm run build:server

  python-quality:
    name: Python quality (3.11)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: python-backend/requirements.txt

      - name: Install dependencies
        working-directory: python-backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety

      - name: Run tests
        working-directory: python-backend
        run: pytest --tb=short

      - name: Bandit security scan
        working-directory: python-backend
        run: bandit -r app -ll

      - name: Safety vulnerability check
        working-directory: python-backend
        run: safety check -r requirements.txt

  shellcheck:
    name: Shell script lint
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          if find build-scripts/shell -name "*.sh" -type f | grep -q "."; then
            find build-scripts/shell -name "*.sh" -type f | xargs shellcheck
          else
            echo "No shell scripts found to lint"
          fi

  ultimate-status:
    name: Ultimate status
    runs-on: ubuntu-latest
    needs:
      - node-quality
      - python-quality
      - shellcheck
    if: ${{ always() }}
    steps:
      - name: Report combined status
        run: |
          echo "Node quality: ${{ needs.node-quality.result }}"
          echo "Python quality: ${{ needs.python-quality.result }}"
          echo "Shellcheck: ${{ needs.shellcheck.result }}"
          if [[ "${{ needs.node-quality.result }}" != "success" || "${{ needs.python-quality.result }}" != "success" || "${{ needs.shellcheck.result }}" != "success" ]]; then
            echo "One or more jobs failed."
            exit 1
          fi
          echo "All jobs succeeded."
